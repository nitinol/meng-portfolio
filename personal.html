<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menguhan - Living Atmosphere</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;300;400;500&display=swap" rel="stylesheet">
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Montserrat', sans-serif;
            color: white;
            /* Default, controlled by JS */
            background: #000;
            transition: color 1s ease;
        }

        /* LAYERS */
        #skyLayer,
        #starCanvas,
        #weatherOverlay,
        #flashOverlay,
        #weatherCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        #skyLayer {
            z-index: 0;
            transition: background 5s ease;
        }

        #starCanvas {
            z-index: 1;
            transition: opacity 5s ease;
        }

        #weatherOverlay {
            z-index: 2;
            transition: background 2s ease;
        }

        #flashOverlay {
            z-index: 3;
            background: white;
            opacity: 0;
        }

        #weatherCanvas {
            z-index: 4;
        }

        /* TOP RIGHT PANEL (Just Degree) */
        .top-bar {
            position: absolute;
            top: 40px;
            right: 50px;
            z-index: 20;
            font-weight: 300;
        }

        .mini-stat {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            /* Larger, cleaner text */
            opacity: 0.9;
            /* No background, "Text Only" */
            cursor: default;
        }

        .weather-icon {
            font-size: 1.8rem;
        }

        .degree-text {
            font-weight: 200;
        }

        /* CENTER MESSAGE */
        .center-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            text-align: center;
            opacity: 0;
            animation: fadeIn 2s forwards 0.5s;
        }

        .title {
            font-size: 3rem;
            font-weight: 100;
            letter-spacing: 4px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .subtitle {
            font-size: 0.9rem;
            font-weight: 400;
            letter-spacing: 2px;
            opacity: 0.8;
            margin-top: 5px;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body>

    <!-- SCENE LAYERS -->
    <div id="skyLayer"></div>
    <canvas id="starCanvas"></canvas>
    <div id="weatherOverlay"></div>
    <div id="flashOverlay"></div>
    <canvas id="weatherCanvas"></canvas>

    <!-- TOP RIGHT INFO -->
    <div class="top-bar">
        <!-- Weather Text Only -->
        <div class="mini-stat" id="weatherBox">
            <span id="wIcon" class="weather-icon"></span>
            <span id="wTemp" class="degree-text">--Â°</span>
        </div>
    </div>

    <!-- CENTER TEXT -->
    <div class="center-message">
        <div class="title">Menguhan</div>
        <div class="subtitle">Under Development</div>
    </div>

    <script>
        // ==========================================
        //  THE ENGINE
        // ==========================================
        const STATE = {
            lat: 40.18, lon: 29.06,
            loaded: false,
            temp: 0,
            weatherCode: 0,
            windSpeed: 0,
            humidity: 0,
            isDay: 1,
            thunderTimer: 0
        };

        const ELS = {
            sky: document.getElementById('skyLayer'),
            stars: document.getElementById('starCanvas'),
            overlay: document.getElementById('weatherOverlay'),
            flash: document.getElementById('flashOverlay'),
            icon: document.getElementById('wIcon'),
            temp: document.getElementById('wTemp'),
            canvas: document.getElementById('weatherCanvas')
        };
        const CTX = ELS.canvas.getContext('2d');
        const STAR_CTX = ELS.stars.getContext('2d');

        function init() {
            resize();
            window.onresize = resize;
            renderStars();

            setInterval(tickClock, 1000);
            setInterval(fetchData, 60000);
            requestAnimationFrame(renderLoop);

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    STATE.lat = pos.coords.latitude;
                    STATE.lon = pos.coords.longitude;
                    fetchData();
                }, () => fetchData());
            } else fetchData();
        }

        function resize() {
            ELS.canvas.width = window.innerWidth;
            ELS.canvas.height = window.innerHeight;
            ELS.stars.width = window.innerWidth;
            ELS.stars.height = window.innerHeight;
            renderStars();
        }

        function renderStars() {
            STAR_CTX.clearRect(0, 0, ELS.stars.width, ELS.stars.height);
            STAR_CTX.fillStyle = "white";
            for (let i = 0; i < 300; i++) {
                const x = Math.random() * ELS.stars.width;
                const y = Math.random() * ELS.stars.height;
                const s = Math.random() * 2;
                STAR_CTX.globalAlpha = Math.random() * 0.8 + 0.2;
                STAR_CTX.beginPath();
                STAR_CTX.arc(x, y, s, 0, Math.PI * 2);
                STAR_CTX.fill();
            }
        }

        async function fetchData() {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${STATE.lat}&longitude=${STATE.lon}&current=temperature_2m,relative_humidity_2m,is_day,weather_code,wind_speed_10m&timezone=auto`;
                const res = await fetch(url);
                const data = await res.json();

                STATE.temp = Math.round(data.current.temperature_2m);
                STATE.humidity = data.current.relative_humidity_2m;
                STATE.isDay = data.current.is_day;
                STATE.weatherCode = data.current.weather_code;
                STATE.windSpeed = data.current.wind_speed_10m;

                STATE.loaded = true;
                tickClock();
            } catch (e) { console.error("API Error", e); }
        }

        function tickClock() {
            const now = new Date();
            const h = now.getHours();
            const m = now.getMinutes();

            if (STATE.loaded) {
                ELS.temp.textContent = `${STATE.temp}Â°`;
                const cond = getWeatherCondition(STATE.weatherCode);
                ELS.icon.textContent = STATE.isDay ? cond.icon : cond.iconNight;
            } else {
                ELS.icon.textContent = "â€¢";
            }

            // --- SKY CALCULATION ---
            const time = h + (m / 60);

            const keys = [
                { t: 0, c: [[222, 47, 11], [222, 47, 15]] },
                { t: 5, c: [[222, 47, 15], [222, 47, 20]] },
                { t: 7, c: [[210, 80, 50], [25, 90, 60]] },
                { t: 10, c: [[200, 90, 50], [195, 90, 80]] },
                { t: 16, c: [[200, 90, 50], [195, 90, 80]] },
                { t: 18, c: [[220, 80, 40], [320, 70, 60]] },
                { t: 20, c: [[240, 50, 20], [240, 50, 10]] },
                { t: 24, c: [[222, 47, 11], [222, 47, 15]] }
            ];

            let start = keys[0];
            let end = keys[keys.length - 1];
            for (let i = 0; i < keys.length - 1; i++) {
                if (time >= keys[i].t && time < keys[i + 1].t) {
                    start = keys[i]; end = keys[i + 1]; break;
                }
            }
            const p = (time - start.t) / (end.t - start.t);

            const top = lerpColorHSL(start.c[0], end.c[0], p);
            const bot = lerpColorHSL(start.c[1], end.c[1], p);

            const mod = getWeatherModifier(STATE.weatherCode);

            const topL = top[2] * mod.light;
            const topFinal = `hsl(${top[0]}, ${top[1] * mod.sat}%, ${topL}%)`;
            const botFinal = `hsl(${bot[0]}, ${bot[1] * mod.sat}%, ${bot[2] * mod.light}%)`;

            ELS.sky.style.background = `linear-gradient(to bottom, ${topFinal}, ${botFinal})`;
            ELS.overlay.style.background = mod.overlay;

            // --- DYNAMIC TEXT COLOR (Contrast) ---
            if (topL > 60) {
                document.body.style.color = 'rgba(0,0,0,0.8)';
            } else {
                document.body.style.color = 'white';
            }

            // --- STAR LOGIC ---
            let starOp = 0;
            if (time >= 20 || time < 6) starOp = 1;
            if (time >= 19 && time < 21) starOp = (time - 19) / 2;
            if (time >= 5 && time < 7) starOp = 1 - ((time - 5) / 2);

            if (STATE.weatherCode > 2) starOp = 0;
            else if (STATE.weatherCode === 2) starOp *= 0.5;

            ELS.stars.style.opacity = starOp;
        }

        // ==========================
        // 4. PARTICLES
        // ==========================
        let particles = [];
        function renderLoop() {
            CTX.clearRect(0, 0, ELS.canvas.width, ELS.canvas.height);
            if (!STATE.loaded) { requestAnimationFrame(renderLoop); return; }

            const cfg = getParticleConfig(STATE.weatherCode);

            if (cfg.thunder && Math.random() < 0.005) {
                ELS.flash.style.opacity = 0.8;
                setTimeout(() => ELS.flash.style.opacity = 0, 100);
            }

            if (cfg.type !== 'none' && particles.length < cfg.count) {
                particles.push(createParticle(cfg));
            }

            CTX.fillStyle = 'rgba(255,255,255,0.6)';
            CTX.strokeStyle = 'rgba(255,255,255,0.4)';
            CTX.lineWidth = 1;

            for (let i = 0; i < particles.length; i++) {
                let p = particles[i];
                p.y += p.dy;
                p.x += p.dx + (STATE.windSpeed * 0.2);

                if (p.type === 'rain') {
                    CTX.beginPath(); CTX.moveTo(p.x, p.y);
                    CTX.lineTo(p.x + (STATE.windSpeed * 0.2), p.y + p.len); CTX.stroke();
                } else if (p.type === 'snow') {
                    p.x += Math.sin(p.y * 0.01) * 0.5;
                    CTX.beginPath(); CTX.arc(p.x, p.y, p.size, 0, Math.PI * 2); CTX.fill();
                } else if (p.type === 'fog') {
                    CTX.fillStyle = `rgba(255,255,255, ${0.05})`;
                    CTX.beginPath(); CTX.arc(p.x, p.y, p.size, 0, Math.PI * 2); CTX.fill();
                    CTX.fillStyle = 'rgba(255,255,255,0.6)';
                }

                if (p.y > ELS.canvas.height + 20 || p.x > ELS.canvas.width + 20) {
                    particles.splice(i, 1); i--;
                }
            }
            requestAnimationFrame(renderLoop);
        }

        function createParticle(cfg) {
            return {
                x: Math.random() * ELS.canvas.width,
                y: -20,
                dx: (Math.random() - 0.5) * 0.5,
                dy: cfg.speed + (Math.random() * 2),
                size: cfg.size + Math.random(),
                len: cfg.len + (Math.random() * 5),
                type: cfg.type
            };
        }

        // Helpers
        function pad(n) { return n < 10 ? '0' + n : n; }
        function lerpColorHSL(a, b, p) {
            return [a[0] + (b[0] - a[0]) * p, a[1] + (b[1] - a[1]) * p, a[2] + (b[2] - a[2]) * p];
        }

        function getWeatherModifier(code) {
            let sat = 1.0, light = 1.0, overlay = 'transparent';
            if (code >= 95) { sat = 0.4; light = 0.3; overlay = 'rgba(20,0,30,0.3)'; }
            else if (code >= 60 || code >= 80) { sat = 0.5; light = 0.7; overlay = 'rgba(0,0,10,0.2)'; }
            else if (code >= 70) { sat = 0.2; light = 1.1; overlay = 'rgba(255,255,255,0.1)'; }
            else if (code >= 45) { sat = 0.1; light = 0.8; overlay = 'rgba(200,200,200,0.2)'; }
            else if (code >= 3) { sat = 0.6; light = 0.9; }
            return { sat, light, overlay };
        }

        function getParticleConfig(code) {
            let c = { type: 'none', count: 0, speed: 0, size: 0, len: 0, thunder: false };
            if (code >= 95) c = { type: 'rain', count: 300, speed: 15, size: 1, len: 20, thunder: true };
            else if (code >= 70 && code <= 77) {
                c = { type: 'snow', count: 200, speed: 1, size: 2, len: 0, thunder: false };
                if (code === 71) c.count = 100; if (code === 75) { c.count = 400; c.speed = 3; }
            } else if ((code >= 51 && code <= 67) || (code >= 80)) {
                c = { type: 'rain', count: 200, speed: 10, size: 1, len: 15, thunder: false };
                if (code <= 55) { c.count = 50; c.speed = 5; }
                if (code >= 65) { c.count = 400; c.speed = 18; }
            } else if (code === 45 || code === 48) {
                c = { type: 'fog', count: 20, speed: 0.2, size: 50, len: 0, thunder: false };
            }
            return c;
        }

        function getWeatherCondition(code) {
            const map = {
                0: { l: "Clear Sky", i: "â˜€ï¸", n: "ğŸŒ™" },
                1: { l: "Mainly Clear", i: "ğŸŒ¤ï¸", n: "ğŸŒ™" },
                2: { l: "Partly Cloudy", i: "â›…", n: "â˜ï¸" },
                3: { l: "Overcast", i: "â˜ï¸", n: "â˜ï¸" },
                45: { l: "Fog", i: "ğŸŒ«ï¸", n: "ğŸŒ«ï¸" }, 48: { l: "Rime Fog", i: "ğŸŒ«ï¸", n: "ğŸŒ«ï¸" },
                51: { l: "Light Drizzle", i: "ğŸŒ¦ï¸", n: "ğŸŒ§ï¸" }, 53: { l: "Drizzle", i: "ğŸŒ¦ï¸", n: "ğŸŒ§ï¸" }, 55: { l: "Heavy Drizzle", i: "ğŸŒ§ï¸", n: "ğŸŒ§ï¸" },
                61: { l: "Slight Rain", i: "ğŸŒ¦ï¸", n: "ğŸŒ§ï¸" }, 63: { l: "Rain", i: "ğŸŒ§ï¸", n: "ğŸŒ§ï¸" }, 65: { l: "Heavy Rain", i: "ğŸŒ§ï¸", n: "ğŸŒ§ï¸" },
                71: { l: "Light Snow", i: "ğŸŒ¨ï¸", n: "ğŸŒ¨ï¸" }, 73: { l: "Snow", i: "ğŸŒ¨ï¸", n: "ğŸŒ¨ï¸" }, 75: { l: "Heavy Snow", i: "â„ï¸", n: "â„ï¸" },
                77: { l: "Snow Grains", i: "ğŸŒ¨ï¸", n: "ğŸŒ¨ï¸" },
                80: { l: "Showers", i: "ğŸŒ¦ï¸", n: "ğŸŒ§ï¸" }, 81: { l: "Heavy Showers", i: "ğŸŒ§ï¸", n: "ğŸŒ§ï¸" }, 82: { l: "Violent Showers", i: "â›ˆï¸", n: "â›ˆï¸" },
                95: { l: "Thunderstorm", i: "â›ˆï¸", n: "âš¡" }, 96: { l: "Thunderstorm & Hail", i: "â›ˆï¸", n: "âš¡" }, 99: { l: "Heavy Hail Storm", i: "â›ˆï¸", n: "âš¡" }
            };
            return map[code] || { l: "Unknown", i: "?", n: "?" };
        }

        init();
    </script>
</body>

</html>